name: CD Pipeline

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure kubectl
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
        chmod 600 $HOME/.kube/config
    
    - name: Verify cluster connection
      run: |
        kubectl cluster-info
        kubectl get nodes
    
    - name: Update deployment image
      run: |
        kubectl set image deployment/flask-bookreviews \
          flask-bookreviews=${{ secrets.DOCKER_USERNAME }}/flask-bookreviews:${{ github.sha }} \
          --record
    
    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/flask-bookreviews
    
    - name: Verify deployment
      run: |
        kubectl get pods -l app=flask-bookreviews
        kubectl get service flask-bookreviews-service
